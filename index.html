<!DOCTYPE html>
<html>
<head>
    <title>Task Manager Client</title>
    <script src="static/external/jquery-1.8.0.min.js"></script>
    <link href="static/external/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/external/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="static/style.css" rel="stylesheet">
    <script src="static/external/rangy-core.js"></script>
    <script src="static/external/textinputs_jquery.js"></script>
    <script src="static/js/util.js"></script>
    <script src="static/js/parser/parser.js"></script>
    <script src="static/js/parser/tag.js"></script>
    <script src="static/js/parser/task.js"></script>
    <script>
        Parser.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Vahur"));
        Parser.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Sujay"));
        Parser.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Aaron"));
        Parser.Tags.push(new Parser.Tag(Parser.Tag.TYPE.CATEGORY, "ENGINEERING"));
        Parser.Tags.push(new Parser.Tag(Parser.Tag.TYPE.CATEGORY, "RECRUITING"));

        var TEST_STRING = "Testing, find @Vahur and !Sujay, maybe see if #ENGINEERING is there also";

        $(function () {
            var task = Parser.parse(TEST_STRING);
            $('#decorated').html(task.decorate());

            $("#task").keyup(function (e) {
                var range = $(e.target).getSelection();
                var description = $(e.target).val();
                $('#decorated').html(Parser.parse(description).decorate());
                if (range.start === range.end) {
                    var root = $("#decorated")[0];
                    var offsetSum = 0;
                    var node = root.childNodes[0];
                    while (offsetSum < range.start) {
                        if (node.hasChildNodes())
                            node = node.childNodes[0];

                        if (offsetSum + node.textContent.length < range.start) {
                            offsetSum += node.textContent.length;
                            if (node.nextSibling)
                                node = node.nextSibling;
                            else
                                node = node.parentNode.nextSibling;
                            continue;
                        }

                        var offset = range.start - offsetSum;
                        var cursorRange = rangy.createRange();
                        cursorRange.setStart(node, offset);
                        cursorRange.collapse(true);
                        cursorRange.insertNode($("<span class='cursor'>&nbsp;</span>")[0]);
                        break;
                    }

                }
            });
        });

    </script>
</head>
<body>

<div class="container">
    <div class="row-fluid" style="margin-top: 20px;">
        <div class="span6">
            <textarea class="span12" id="task">Testing, find @Vahur and !Sujay, maybe see if #ENGINEERING is there also</textarea>
            <h3>Suggestions</h3>
            <ul>
                <li>Test</li>
            </ul>
        </div>
        <div class="span6"><div class="span12" id="decorated"></div></div>
    </div>
</div>

</body>
</html>