<!DOCTYPE html>
<html>
<head>
    <title>Task Manager Client</title>
    <script src="static/external/jquery-1.8.0.min.js"></script>
    <link href="static/external/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/external/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="static/style.css" rel="stylesheet">
    <script src="static/external/rangy-core.js"></script>
    <script src="static/external/textinputs_jquery.js"></script>
    <script src="static/js/util.js"></script>
    <script src="static/js/user.js"></script>
    <script src="static/js/parser/parser.js"></script>
    <script src="static/js/parser/tag.js"></script>
    <script src="static/js/parser/task.js"></script>
    <script src="static/js/autocomplete.js"></script>
    <script>
        Autocomplete.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Vahur"));
        Autocomplete.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Sujay"));
        Autocomplete.Tags.push(new Parser.Tag(Parser.Tag.TYPE.USER, "Aaron"));
        Autocomplete.Tags.push(new Parser.Tag(Parser.Tag.TYPE.CATEGORY, "ENGINEERING"));
        Autocomplete.Tags.push(new Parser.Tag(Parser.Tag.TYPE.CATEGORY, "RECRUITING"));

        var TEST_STRING = "Testing, find @Vahur and !Sujay, maybe see if #ENGINEERING is there also";

        $(function () {
            var task = Parser.parse(TEST_STRING);
            $('#decorated').html(task.decorate());

            $("#task").keydown(function (e) {
                setTimeout(function () {
                    var range = $(e.target).getSelection();
                    var description = $(e.target).val();
                    var task = Parser.parse(description);
                    $('#decorated').html(task.decorate());

                    if (range.start === range.end) {
                        var root = $("#decorated")[0];
                        var offsetSum = 0;
                        var node = root.childNodes[0];

                        while (offsetSum < range.start) {
                            if (node.hasChildNodes())
                                node = node.childNodes[0];

                            if (offsetSum + node.textContent.length < range.start) {
                                offsetSum += node.textContent.length;
                                if (node.nextSibling)
                                    node = node.nextSibling;
                                else
                                    node = node.parentNode.nextSibling;
                                continue;
                            }

                            var offset = range.start - offsetSum;
                            var cursorRange = rangy.createRange();
                            cursorRange.setStart(node, offset);
                            cursorRange.collapse(true);
                            cursorRange.insertNode($("<span class='cursor'>&nbsp;</span>")[0]);
                            break;
                        }
                    }

                    var action = (e.keyCode === 8) ? User.Action.BACKSPACE : User.Action.TYPE;

                    if (e.keyCode >= 37 && e.keyCode <= 40)
                        action = User.Action.ARROW_KEY;

                    Autocomplete.complete(task, range.start, action);
                }, 1);
            });
        });

    </script>
</head>
<body>

<div class="container">
    <div class="row-fluid" style="margin-top: 20px;">
        <div class="span6">
            <textarea class="span12" id="task">Testing, find @Vahur and !Sujay, maybe see if #ENGINEERING is there also</textarea>
            <h3>Suggestions</h3>
            <ul>
                <li>Test</li>
            </ul>
        </div>
        <div class="span6">
            <div class="span12" id="decorated"></div>

            <ul class="span12">
                <li>Active Word: <span id="activeWord">tere</span></li>
            </ul>
        </div>
    </div>
</div>

</body>
</html>